<!DOCTYPE html>
<html lang="bg" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админ — Cane Corso BG</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="container brandbar">
      <a class="logo-wrap" href="index.html"><img src="assets/logo.svg" class="brand-logo" alt=""><div><h1>Регистър CANE CORSO — България</h1><p class="motto-top">“UNA QUAEDAM” — A UNIQUE ONE</p></div></a>
      <div class="nav-right" id="navbar"><a class="btn link" href="login.html">Вход</a><a class="btn primary" href="register.html">Регистрация</a></div>
    </div>
  </header>

  <main class="container">
    <section class="fade-in">
      <h2>Админ панел</h2>
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="pending">Чакащи</button>
        <button class="tab" data-tab="approved">Одобрени</button>
        <button class="tab" data-tab="rejected">Отхвърлени</button>
      </div>

      <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:12px">
        <input id="q" class="input" placeholder="Търси по име…">
        <button id="searchBtn" class="btn">Търси</button>
      </div>

      <div id="rows" class="grid"></div>
    </section>
  </main>

  <footer class="footer"><small>© 2025 Cane Corso Registry BG · MIT</small></footer>

  <script type="module">
    import { bootstrap, requireAdmin } from './js/app.js';
    import { adminListDogs, adminApprove, adminReject, getDogById, updateDog, setCover, deletePhoto } from './js/api.js';
    import { openLightbox } from './js/lightbox.js';
    bootstrap(); await requireAdmin('login.html');

    const rowsEl = document.getElementById('rows');
    const tabs = document.querySelectorAll('.tab');
    let status='pending', query='';

    document.getElementById('searchBtn').onclick=()=>{ query=document.getElementById('q').value.trim(); load(); };
    tabs.forEach(t=> t.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); status=t.dataset.tab; load(); });

    async function load(){
      rowsEl.innerHTML=`<div class="skeleton" style="height:120px;border-radius:12px"></div>`;
      const all = await adminListDogs(status);
      const rows = query ? all.filter(r => (r.name||'').toLowerCase().includes(query.toLowerCase())) : all;
      rowsEl.innerHTML = rows.length ? rows.map(r=>`
        <article class="dog-card">
          <img src="${r.cover_url || 'assets/placeholder.png'}" alt="${r.name||''}">
          <div class="body">
            <h3 style="margin:0">${r.name||'Без име'}</h3>
            <div class="muted" style="margin:.2rem 0">Статус: ${r.status} · ${r.sex||'—'} · ${r.color||'—'} · ${r.city||'—'}</div>
            <div class="row-actions">
              <button class="btn primary" data-open="${r.id}">Отвори</button>
              ${r.status!=='approved'?`<button class="btn" data-approve="${r.id}">Одобри</button>`:''}
              ${r.status!=='rejected'?`<button class="btn danger" data-reject="${r.id}">Откажи</button>`:''}
            </div>
          </div>
        </article>
      `).join('') : `<div class="empty">Няма записи.</div>`;

      rowsEl.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> openEditor(b.dataset.open));
      rowsEl.querySelectorAll('[data-approve]').forEach(b=> b.onclick=async()=>{ await adminApprove(b.dataset.approve); load(); });
      rowsEl.querySelectorAll('[data-reject]').forEach(b=> b.onclick=async()=>{ const reason=prompt('Причина за отказ:')||''; await adminReject(b.dataset.reject,reason); load(); });
    }

    async function openEditor(id){
      const dog = await getDogById(id);
      const backdrop = document.createElement('div');
      backdrop.className='modal-backdrop';
      backdrop.innerHTML=`
        <div class="modal-panel" style="width:min(96vw,1000px)">
          <div class="modal-header"><strong>Редакция: ${dog.name||'Без име'}</strong><button class="modal-close">✕</button></div>
          <div class="form-stack">
            <div style="display:grid;grid-template-columns:320px 1fr;gap:16px;align-items:start">
              <img id="cover" src="${dog.cover_url || 'assets/placeholder.png'}" alt="" style="width:100%;border-radius:10px;border:1px solid #333;background:#111">
              <div>
                <div class="form-row">
                  <input class="input" id="fName" placeholder="Име *" value="${dog.name||''}">
                  <select class="input" id="fSex">
                    <option value="male" ${dog.sex==='male'?'selected':''}>♂ мъжко</option>
                    <option value="female" ${dog.sex==='female'?'selected':''}>♀ женско</option>
                  </select>
                  <input class="input" id="fDOB" type="date" value="${dog.date_of_birth||''}">
                  <input class="input" id="fColor" placeholder="Цвят" value="${dog.color||''}">
                  <input class="input" id="fCity" placeholder="Град" value="${dog.city||''}">
                </div>
                <div class="form-row">
                  <select class="input" id="fStatus">
                    <option value="draft" ${dog.status==='draft'?'selected':''}>draft</option>
                    <option value="pending" ${dog.status==='pending'?'selected':''}>pending</option>
                    <option value="approved" ${dog.status==='approved'?'selected':''}>approved</option>
                    <option value="rejected" ${dog.status==='rejected'?'selected':''}>rejected</option>
                  </select>
                  <input class="input" id="fReason" placeholder="Причина за отказ" value="${dog.rejection_reason||''}">
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn primary" id="saveDog">Запази</button>
                  <button class="btn" id="doApprove">Одобри</button>
                  <button class="btn danger" id="doReject">Откажи</button>
                </div>
                <div id="msg" class="muted"></div>
              </div>
            </div>

            <div class="card">
              <strong>Снимки</strong>
              <div id="phGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px"></div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(backdrop);
      const close=()=>backdrop.remove();
      backdrop.addEventListener('click', e=>{ if(e.target===backdrop) close(); });
      backdrop.querySelector('.modal-close').onclick=close;

      const msg = backdrop.querySelector('#msg');
      await refreshPhotos();
      backdrop.querySelector('#saveDog').onclick=save;
      backdrop.querySelector('#doApprove').onclick=async()=>{ await adminApprove(id); await load(); close(); }
      backdrop.querySelector('#doReject').onclick=async()=>{ const r=backdrop.querySelector('#fReason').value||prompt('Причина за отказ:')||''; await adminReject(id,r); await load(); close(); }

      async function save(){
        const payload = {
          name:backdrop.querySelector('#fName').value.trim(),
          sex:backdrop.querySelector('#fSex').value,
          date_of_birth:backdrop.querySelector('#fDOB').value || null,
          color:backdrop.querySelector('#fColor').value || null,
          city:backdrop.querySelector('#fCity').value || null,
          status:backdrop.querySelector('#fStatus').value,
          rejection_reason:backdrop.querySelector('#fReason').value || null,
        };
        try{ await updateDog(id,payload); msg.textContent='Записано.'; await load(); }
        catch(e){ msg.textContent=e.message||'Грешка при запис.'; }
      }

      async function refreshPhotos(){
        const fresh = await getDogById(id);
        const urls=(fresh.photos||[]).map(p=>p.url).filter(Boolean);
        const grid=backdrop.querySelector('#phGrid');
        grid.innerHTML = (fresh.photos||[]).map((p,i)=>`
          <div class="thumb">
            <img data-i="${i}" src="${p.url}" alt="">
            <div class="actions">
              <button class="btn" data-cover="${p.path}">Корицa</button>
              <button class="btn danger" data-del="${p.id}" data-path="${p.path}">Изтрий</button>
            </div>
          </div>`).join('') || '<span class="muted">няма</span>';
        grid.addEventListener('click', (e)=>{
          const el=e.target.closest('img[data-i]'); if(!el) return;
          openLightbox(urls, Number(el.dataset.i||0));
        });
        grid.querySelectorAll('[data-cover]').forEach(b=> b.onclick=async()=>{ await setCover(id,b.dataset.cover); await refreshPhotos(); });
        grid.querySelectorAll('[data-del]').forEach(b=> b.onclick=async()=>{ await deletePhoto(b.dataset.del,b.dataset.path); await refreshPhotos(); });
      }
    }

    load();
  </script>
  <script type="module" src="js/lightbox.js"></script>
</body>
</html>
