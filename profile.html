<!DOCTYPE html>
<html lang="bg" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Ñ–∏–ª ‚Äî Cane Corso BG</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="container brandbar">
      <a class="logo-wrap" href="index.html"><img src="assets/logo.svg" class="brand-logo" alt=""><div><h1>–†–µ–≥–∏—Å—Ç—ä—Ä CANE CORSO ‚Äî –ë—ä–ª–≥–∞—Ä–∏—è</h1><p class="motto-top">‚ÄúUNA QUAEDAM‚Äù ‚Äî A UNIQUE ONE</p></div></a>
      <div class="nav-right" id="navbar"><a class="btn link" href="login.html">–í—Ö–æ–¥</a><a class="btn primary" href="register.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
    </div>
    <nav class="nav">
      <div class="container nav-row">
        <div class="nav-left"><ul><li><a class="nav-link" href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li></ul></div>
        <div class="nav-tools"><button class="btn link" id="themeBtn">üåì</button><button class="btn link" id="burgerBtn">‚ò∞</button></div>
      </div>
    </nav>
  </header>

  <main class="container">
    <section>
      <h2>–ú–æ–∏—Ç–µ –∑–∞–ø–∏—Å–∏</h2>

      <details id="editor" open class="card">
        <summary><strong>+ –ù–æ–≤ / –†–µ–¥–∞–∫—Ü–∏—è –Ω–∞ –∑–∞–ø–∏—Å</strong></summary>
        <form id="dogForm" class="form-stack" style="margin-top:10px">
          <div class="form-row">
            <input class="input" name="name" placeholder="–ò–º–µ *" required>
            <select class="input" name="sex">
              <option value="male">‚ôÇ –º—ä–∂–∫–æ</option>
              <option value="female">‚ôÄ –∂–µ–Ω—Å–∫–æ</option>
            </select>
            <input class="input" name="date_of_birth" type="date" placeholder="–î–∞—Ç–∞ –Ω–∞ —Ä–∞–∂–¥–∞–Ω–µ">
            <input class="input" name="color" placeholder="–¶–≤—è—Ç">
            <input class="input" name="city" placeholder="–ì—Ä–∞–¥">
            <input class="input" name="microchip" placeholder="–ú–∏–∫—Ä–æ—á–∏–ø">
            <input class="input" name="pedigree" placeholder="‚Ññ –†–æ–¥–æ—Å–ª–æ–≤–∏–µ">
          </div>

          <div class="uploader hidden" id="uploader">
            <div id="drop" class="dropzone">–ü—É—Å–Ω–∏ —Å–Ω–∏–º–∫–∏ —Ç—É–∫ –∏–ª–∏ <button type="button" id="pick" class="btn">–∏–∑–±–µ—Ä–∏</button></div>
            <input type="file" id="file" accept="image/*" multiple class="hidden" />
            <div id="thumbs" class="thumbs"></div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="saveBtn">–ó–∞–ø–∞–∑–∏</button>
            <button type="button" class="btn" id="submitBtn" disabled>–ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>
          </div>
          <div id="msg" class="muted"></div>
        </form>
      </details>

      <div id="list" class="grid" style="margin-top:14px"></div>
    </section>
  </main>

  <footer class="footer"><small>¬© 2025 Cane Corso Registry BG ¬∑ MIT</small></footer>

  <script type="module">
    import { bootstrap, requireAuth } from './js/app.js';
    import { myDogs, createDog, updateDog, uploadDogPhoto, submitDog, getDogById, setCover, deletePhoto } from './js/api.js';
    bootstrap(); await requireAuth('login.html');

    const els = {
      form: document.getElementById('dogForm'),
      msg: document.getElementById('msg'),
      uploader: document.getElementById('uploader'),
      drop: document.getElementById('drop'),
      pick: document.getElementById('pick'),
      file: document.getElementById('file'),
      thumbs: document.getElementById('thumbs'),
      submitBtn: document.getElementById('submitBtn'),
      list: document.getElementById('list')
    };

    let editingId = null;

    function payload(){
      const fd=new FormData(els.form);
      return {
        name: fd.get('name')?.toString().trim(),
        sex: fd.get('sex') || 'male',
        date_of_birth: fd.get('date_of_birth') || null,
        color: fd.get('color') || null,
        city: fd.get('city') || null,
        microchip: fd.get('microchip') || null,
        pedigree: fd.get('pedigree') || null,
      };
    }

    async function loadList(){
      els.list.innerHTML=`<div class="skeleton" style="height:120px;border-radius:12px"></div>`;
      const rows = await myDogs();
      els.list.innerHTML = rows.length ? rows.map(r=>`
        <article class="dog-card">
          <img src="${r.cover_url || 'assets/placeholder.png'}" alt="${r.name||''}">
          <div class="body">
            <h3 style="margin:0">${r.name||'–ë–µ–∑ –∏–º–µ'}</h3>
            <div class="muted" style="margin:.2rem 0">–°—Ç–∞—Ç—É—Å: ${r.status} ¬∑ ${r.sex||'‚Äî'} ¬∑ ${r.color||'‚Äî'} ¬∑ ${r.city||'‚Äî'}</div>
            <div class="actions" style="display:flex;gap:6px;flex-wrap:wrap">
              <a class="btn" href="details.html?id=${r.id}">–ü—Ä–µ–≥–ª–µ–¥</a>
              <button class="btn" data-edit="${r.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
              ${r.status!=='pending' && r.status!=='approved' ? `<button class="btn primary" data-submit="${r.id}">–ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>`:''}
            </div>
          </div>
        </article>
      `).join('') : `<div class="empty">–ù—è–º–∞—à –∑–∞–ø–∏—Å–∏ –æ—â–µ.</div>`;

      els.list.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> loadEditor(b.dataset.edit));
      els.list.querySelectorAll('[data-submit]').forEach(b=> b.onclick=async()=>{ await submitDog(b.dataset.submit); await loadList(); });
    }

    function fillForm(d){
      els.form.querySelector('[name="name"]').value = d.name || '';
      els.form.querySelector('[name="sex"]').value = d.sex || 'male';
      els.form.querySelector('[name="date_of_birth"]').value = d.date_of_birth || '';
      els.form.querySelector('[name="color"]').value = d.color || '';
      els.form.querySelector('[name="city"]').value = d.city || '';
      els.form.querySelector('[name="microchip"]').value = d.microchip || '';
      els.form.querySelector('[name="pedigree"]').value = d.pedigree || '';
    }

    async function renderThumbs(dog){
      const fresh = await getDogById(dog.id);
      const photos = fresh.photos || [];
      els.thumbs.innerHTML = photos.length ? photos.map(p=>`
        <div class="thumb">
          <img src="${p.url}" alt="">
          <div class="actions">
            <button class="btn" data-cover="${p.path}">–ö–æ—Ä–∏—Üa</button>
            <button class="btn danger" data-del="${p.id}" data-path="${p.path}">–ò–∑—Ç—Ä–∏–π</button>
          </div>
        </div>
      `).join('') : `<div class="empty">–ù—è–º–∞ —Å–Ω–∏–º–∫–∏ ‚Äî –∫–∞—á–∏ –ø–æ–Ω–µ –µ–¥–Ω–∞.</div>`;

      els.thumbs.querySelectorAll('[data-cover]').forEach(b => b.onclick=async()=>{ await setCover(dog.id, b.dataset.cover); await renderThumbs(dog); });
      els.thumbs.querySelectorAll('[data-del]').forEach(b => b.onclick=async()=>{ await deletePhoto(b.dataset.del, b.dataset.path); await renderThumbs(dog); });
    }

    async function loadEditor(id){
      editingId = id || null;
      els.msg.textContent=''; els.submitBtn.disabled=!editingId;

      if(!editingId){
        els.form.reset(); els.uploader.classList.add('hidden'); els.thumbs.innerHTML='';
        document.getElementById('editor').open = true;
        els.form.querySelector('[name="name"]').focus();
        return;
      }
      document.getElementById('editor').open = true;
      const dog = await getDogById(editingId);
      fillForm(dog); await renderThumbs(dog);
      els.uploader.classList.remove('hidden');
    }

    // save
    els.form.addEventListener('submit', async (e)=>{
      e.preventDefault(); els.msg.textContent='–ó–∞–ø–∏—Å–≤–∞–º‚Ä¶';
      try{
        if(editingId){ await updateDog(editingId, payload()); }
        else{
          const row = await createDog(payload());
          editingId = row.id; els.submitBtn.disabled=false; els.uploader.classList.remove('hidden');
        }
        els.msg.textContent='–ì–æ—Ç–æ–≤–æ.'; await loadList();
        if(editingId){ const d = await getDogById(editingId); await renderThumbs(d); }
      }catch(err){ els.msg.textContent=err.message||'–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å.'; }
    });

    // uploader
    els.pick.addEventListener('click', ()=> els.file.click());
    els.file.addEventListener('change', async ()=>{
      if(!editingId) return alert('–ü—ä—Ä–≤–æ –∑–∞–ø–∞–∑–∏ –∑–∞–ø–∏—Å–∞.'); await uploadMany([...els.file.files]); els.file.value='';
    });
    ['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); els.drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); els.drop.classList.remove('drag'); }));
    els.drop.addEventListener('drop', async (e)=>{
      if(!editingId) return alert('–ü—ä—Ä–≤–æ –∑–∞–ø–∞–∑–∏ –∑–∞–ø–∏—Å–∞.');
      const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')); await uploadMany(files);
    });
    async function uploadMany(files){
      els.msg.textContent=`–ö–∞—á–≤–∞–º ${files.length} —Ñ–∞–π–ª(–∞)‚Ä¶`;
      for(const f of files){ try{ await uploadDogPhoto(editingId, f); }catch{} }
      els.msg.textContent='–ö–∞—á–µ–Ω–æ.'; const d=await getDogById(editingId); await renderThumbs(d); await loadList();
    }

    await loadList(); loadEditor(null);
  </script>
</body>
</html>
